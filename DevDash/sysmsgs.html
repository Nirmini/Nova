<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Novaworks</title>
  <link rel="icon" href="../Icos/Nova/Nova-DevIconT.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #181a1b;
      --panel-bg: #23272a;
      --text: #f3f3f3;
      --border: #333;
      --accent: #5865f2;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .navbar {
      display: flex;
      align-items: center;
      background: #23272a;
      padding: 10px 24px;
      height: 60px;
      box-sizing: border-box;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .navbar-logo { height: 40px; margin-right: 24px; }
    .navbar-buttons { display: flex; gap: 12px; }
    .navbar-button {
      background: #2c2f33; color: #fff; border: none;
      padding: 10px 18px; border-radius: 6px;
      cursor: pointer; transition: background 0.2s;
    }
    .navbar-button:hover { background: var(--accent); }

    /* Layout */
    .workspace { flex: 1; display: flex; overflow: hidden; }
    .editor-pane {
      width: 400px; background: var(--panel-bg);
      padding: 16px; border-right: 1px solid var(--border);
      overflow-y: auto;
    }
    .preview-pane { flex: 1; padding: 16px; background: var(--bg); overflow-y: auto; }

    .section { margin-bottom: 20px; }
    .section h3 { margin: 0; font-size: 1rem; color: var(--accent); }

    input, select, textarea, button {
      width: 100%; margin-top: 6px; padding: 8px;
      border-radius: 6px; border: 1px solid var(--border);
      background: var(--bg); color: var(--text);
    }
    textarea { resize: vertical; max-width: 100%; }
    button { background: var(--accent); color: #fff; border: none; cursor: pointer; }
    button:hover { background: #4752c4; }

    .radio-inline { display: inline-flex; align-items: center; gap: 8px; margin-right: 16px; }

    /* Discord Preview */
    .discord-message { display: flex; gap: 12px; margin-bottom: 16px; }
    .discord-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .discord-content { flex: 1; }
    .discord-header { font-weight: 600; color: #fff; }
    .discord-header .app-tag {
      background: #5865f2; color: #fff; font-size: 0.7rem;
      padding: 1px 4px; border-radius: 5px; margin-left: 4px;
    }
    .discord-header .timestamp {
      font-weight: normal; color: #aaa; font-size: 0.85rem; margin-left: 4px;
    }
    .preview-message { margin-top: 2px; }
    .embed {
      border-left: 4px solid var(--accent);
      padding: 8px; margin-top: 8px;
      background: rgba(88,101,242,0.1); border-radius: 4px;
    }
    .component-block {
      border: 1px dashed var(--accent);
      padding: 8px; margin-top: 8px; border-radius: 6px;
    }
    .discord-buttons { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .discord-button {
      background: #2c2f33;
      color: #fff;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .discord-button.link { background: transparent; color: #00aff4; }
    .preview-message h1, 
    .preview-message h2, 
    .preview-message h3 {
      margin: 4px 0;
      font-weight: 600;
    }
    .preview-message h1 { font-size: 1.1rem; }
    .preview-message h2 { font-size: 1rem; }
    .preview-message h3 { font-size: 0.95rem; }

    .preview-message ul {
      list-style-type: disc;
      margin: 4px 0 4px 1.2em;
      padding: 0;
    }
    .preview-message li {
      margin: 2px 0;
    }

    .preview-message code {
      background: #2f3136;
      padding: 2px 4px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .preview-message pre {
      background: #2f3136;
      padding: 8px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 0.9em;
    }
    .color-control {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      width: 33%;
      min-width: 150px;
    }
    .color-square {
      flex: 1;
      aspect-ratio: 1 / 1;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid var(--border);
    }
    .color-control input[type="text"] {
      flex: 2;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <img src="../Icos/Nova/Novaworks-Banner.png" alt="NovaBot Logo" class="navbar-logo">
    <div class="navbar-buttons">
      <button class="navbar-button" onclick="location.href='index.html'">Operation Stats</button>
      <button class="navbar-button" onclick="location.href='manage.html'">Operations Management</button>
      <button class="navbar-button" onclick="location.href='sysmsgs.html'">SysMsgMngr</button>
      <button class="navbar-button" onclick="location.href='settings.html'">Settings & Legal</button>
    </div>
  </nav>

  <div class="workspace">
    <div class="editor-pane">
      <form id="composer">
        <div class="section">
          <h3>Target</h3>
          <label class="radio-inline"><input type="radio" name="type" value="dm" checked> DM User</label>
          <label class="radio-inline"><input type="radio" name="type" value="channel"> Channel</label>
          <input type="text" name="userId" placeholder="User ID (for DM)">
          <select name="guildId" style="display:none;"></select>
          <select name="channelId" style="display:none;"></select>
        </div>

        <div class="section">
          <h3>Message</h3>
          <textarea name="content" placeholder="Message content..."></textarea>
          <button type="button" id="addEmbed">+ Add Embed</button>
          <button type="button" id="addComponent">+ Add Component</button>
        </div>

        <div class="section" id="extraBlocks"></div>

        <button type="submit">Send</button>
      </form>
    </div>

    <div class="preview-pane">
      <h2>Live Preview</h2>
      <div id="preview"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('composer');
    const preview = document.getElementById('preview');
    const extraBlocks = document.getElementById('extraBlocks');

    // --- DM/Channel toggle
    document.querySelectorAll('input[name="type"]').forEach(el => {
      el.addEventListener('change', e => {
        const isDM = e.target.value === 'dm';
        form.userId.style.display = isDM ? '' : 'none';
        form.guildId.style.display = isDM ? 'none' : '';
        form.channelId.style.display = isDM ? 'none' : '';
      });
    });

    // --- Populate guilds/channels
    async function loadGuilds() {
      const res = await fetch('http://localhost:65522/api/guilds');
      const guilds = await res.json();
      form.guildId.innerHTML = guilds.map(g => `<option value="${g.id}">${g.name}</option>`).join("");
      if (guilds[0]) loadChannels(guilds[0].id);
    }
    async function loadChannels(guildId) {
      const res = await fetch(`http://localhost:65522/api/guilds/${guildId}/channels`);
      const chans = await res.json();
      form.channelId.innerHTML = chans
        .filter(c => c.type === 0) // text channels only
        .map(c => `<option value="${c.id}">#${c.name}</option>`).join("");
    }
    form.guildId?.addEventListener("change", e => loadChannels(e.target.value));
    loadGuilds();

    // --- Add Embed block
    document.getElementById('addEmbed').addEventListener('click', () => {
      const div = document.createElement('div');
      div.className = "embed-block";
      div.innerHTML = `
        <h4>Embed <button type="button" style="background-color: #f25858;" class="delete-block">❌Delete</button></h4>
        <input type="text" name="embedTitle" placeholder="Embed Title">
        <textarea name="embedDesc" placeholder="Embed Description"></textarea>
        <div class="color-control">
          <div class="color-square" style="background:#5865f2;"></div>
          <input type="text" name="embedColor" value="#5865f2">
          <input type="color" class="color-picker" value="#5865f2" style="display:none;">
        </div>
      `;

      div.querySelector('.delete-block').addEventListener('click', () => {
        div.remove();
        document.getElementById('addComponent').disabled = false;
        updatePreview();
      });

      const square = div.querySelector('.color-square');
      const textbox = div.querySelector('[name="embedColor"]');
      const picker = div.querySelector('.color-picker');

      square.addEventListener('click', () => picker.click());
      picker.addEventListener('input', e => {
        textbox.value = e.target.value;
        square.style.background = e.target.value;
        updatePreview();
      });
      textbox.addEventListener('input', e => {
        const val = e.target.value;
        if (/^#([0-9A-F]{3}){1,2}$/i.test(val)) {
          square.style.background = val;
          picker.value = val;
          updatePreview();
        }
      });

      extraBlocks.appendChild(div);
      document.getElementById('addComponent').disabled = true;
      updatePreview();
    });

    // --- Add Component block
    function createComponentBlock() {
      const div = document.createElement('div');
      div.className = "component-block";
      div.innerHTML = `
        <h4>Component <button type="button" style="background-color: #f25858;" class="delete-block">❌Delete</button></h4>
        <select name="compType">
          <option value="actionrow">Action Row</option>
          <option value="button">Button</option>
          <option value="stringselect">String Select</option>
          <option value="textinput">Text Input</option>
          <option value="userselect">User Select</option>
          <option value="roleselect">Role Select</option>
          <option value="mentionableselect">Mentionable Select</option>
          <option value="channelselect">Channel Select</option>
          <option value="section">Section</option>
          <option value="textdisplay">Text Display</option>
          <option value="thumbnail">Thumbnail</option>
          <option value="mediagallery">Media Gallery</option>
          <option value="file">File</option>
          <option value="separator">Separator</option>
          <option value="container">Container</option>
          <option value="label">Label</option>
          <option value="link">Link Button</option>
        </select>
        <div class="comp-fields"></div>
        <button type="button" class="addChild">+ Add Child Component</button>
      `;

      div.querySelector('.delete-block').addEventListener('click', () => {
        div.remove();
        form.content.disabled = false;
        document.getElementById('addEmbed').disabled = false;
        updatePreview();
      });

      const sel = div.querySelector('[name="compType"]');
      const fields = div.querySelector('.comp-fields');
      const renderFields = () => {
        fields.innerHTML = "";
        switch (sel.value) {
          case "button":
            fields.innerHTML = `
              <input type="text" name="compLabel" placeholder="Button Label">
              <input type="text" name="compId" placeholder="Custom ID">
            `;
            break;
          case "stringselect":
            fields.innerHTML = `
              <input type="text" name="compPlaceholder" placeholder="Placeholder">
              <textarea name="compOptions" placeholder="Options (comma-separated)"></textarea>
            `;
            break;
          case "link":
            fields.innerHTML = `
              <input type="text" name="compLabel" placeholder="Button Label">
              <input type="url" name="compUrl" placeholder="https://example.com">
            `;
            break;
          case "textdisplay":
            fields.innerHTML = `<textarea name="compText" placeholder="Markdown text"></textarea>`;
            break;
          case "thumbnail":
            fields.innerHTML = `<input type="url" name="compUrl" placeholder="Image URL">`;
            break;
          case "mediagallery":
            fields.innerHTML = `<textarea name="compUrls" placeholder="Media URLs (comma-separated)"></textarea>`;
            break;
          case "file":
            fields.innerHTML = `<input type="text" name="compFile" placeholder="File name">`;
            break;
          case "label":
            fields.innerHTML = `
              <input type="text" name="compLabel" placeholder="Label">
              <textarea name="compDesc" placeholder="Description"></textarea>
            `;
            break;
          default:
            fields.innerHTML = `<em>No extra fields for this type</em>`;
        }
      };
      sel.addEventListener('change', renderFields);
      renderFields();

      // Add child
      div.querySelector('.addChild').addEventListener('click', () => {
        const child = createComponentBlock();
        child.classList.add("nested");
        div.appendChild(child);
        updatePreview();
      });

      return div;
    }

    document.getElementById('addComponent').addEventListener('click', () => {
      const block = createComponentBlock();
      extraBlocks.appendChild(block);
      form.content.disabled = true;
      document.getElementById('addEmbed').disabled = true;
      updatePreview();
    });

    // --- Recursive render
    function renderComponent(block) {
      const type = block.querySelector('[name="compType"]')?.value;
      let html = "";

      if (type === "button") {
        const label = block.querySelector('[name="compLabel"]')?.value || "Button";
        html = `<div class="discord-button">${label}</div>`;
      } else if (type === "stringselect") {
        html = `<div class="discord-button">▼ String Select</div>`;
      } else if (type === "link") {
        const label = block.querySelector('[name="compLabel"]')?.value || "Link";
        html = `<div class="discord-button link">${label}</div>`;
      } else if (type === "textdisplay") {
        const text = block.querySelector('[name="compText"]')?.value || "Text";
        html = `<div>${text}</div>`;
      } else if (type === "thumbnail") {
        const url = block.querySelector('[name="compUrl"]')?.value || "";
        if (url) html = `<img src="${url}" style="max-width:80px;max-height:80px;border-radius:4px;margin:4px;">`;
      } else {
        html = `<div>[${type}]</div>`;
      }

      // render children if any
      block.querySelectorAll('.component-block.nested').forEach(child => {
        html += renderComponent(child);
      });
      return html;
    }

    function discordMarkdownToHtml(text) {
      if (!text) return "";

      // Escape < >
      let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

      // Headings
      html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
      html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

      // Small text
      html = html.replace(/-# (.*)/g, '<span style="font-size:0.85em;color:#aaa;">$1</span>');

      // Bold/italic/etc
      html = html.replace(/\*\*\*(.*?)\*\*\*/g, "<b><i>$1</i></b>");
      html = html.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
      html = html.replace(/\*(.*?)\*/g, "<i>$1</i>");
      html = html.replace(/__(.*?)__/g, "<u>$1</u>");
      html = html.replace(/_(.*?)_/g, "<i>$1</i>");
      html = html.replace(/~~(.*?)~~/g, "<s>$1</s>");

      // Inline code
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Code blocks
      html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

      // Lists (-, with nesting by spaces)
      html = html.replace(/^( {0,2})- (.*)$/gim, '<ul><li>$2</li></ul>');
      html = html.replace(/^( {2,4})- (.*)$/gim, '<ul style="margin-left:1em;"><li>$2</li></ul>');
      html = html.replace(/^( {4,})- (.*)$/gim, '<ul style="margin-left:2em;"><li>$2</li></ul>');

      // Line breaks
      html = html.replace(/\n/g, "<br>");

      return html;
    }

    function updatePreview() {
      const now = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      let html = `<div class="discord-message">
        <img src="https://nirmini.dev/imgs/Nova/v4/Nightsmith-V3Logo-Dev.png" class="discord-avatar">
        <div class="discord-content">
          <div class="discord-header">Nova <span class="app-tag">APP</span><span class="timestamp">Today at ${now}</span></div>
          <div class="preview-message">`;

      if (!form.content.disabled && form.content.value) {
        html += discordMarkdownToHtml(form.content.value);
      }

      extraBlocks.querySelectorAll('.embed-block').forEach(block => {
        const title = block.querySelector('[name="embedTitle"]')?.value || "";
        const desc = block.querySelector('[name="embedDesc"]')?.value || "";
        const color = block.querySelector('[name="embedColor"]')?.value || "#5865f2";
          
        html += `<div class="embed" style="border-left:4px solid ${color}; background:${color}20;">
          <strong>${discordMarkdownToHtml(title)}</strong><br>
          ${discordMarkdownToHtml(desc)}
        </div>`;
      });

      const compBlocks = extraBlocks.querySelectorAll('.component-block:not(.nested)');
      if (compBlocks.length > 0) {
        html += `<div class="discord-buttons">`;
        compBlocks.forEach(block => {
          html += renderComponent(block);
        });
        html += `</div>`;
      }

      html += `</div></div></div>`;
      preview.innerHTML = html;
    }

    form.addEventListener('input', updatePreview);
    form.addEventListener('submit', async e => {
      e.preventDefault();

      const type = form.type.value; // dm or channel
      const payload = { 
        type, 
        devUserId: "600464355917692952" // I don't feel like setting this up rn
      };

      if (type === "dm") {
        payload.userId = form.userId.value.trim();
      } else {
        payload.guildId = form.guildId.value;
        payload.channelId = form.channelId.value;
      }

      // Plain content
      if (!form.content.disabled && form.content.value) {
        payload.messageType = "text";
        payload.content = form.content.value;
      }

      // Embeds
      const embedBlocks = extraBlocks.querySelectorAll('.embed-block');
      if (embedBlocks.length > 0) {
        payload.messageType = "embed";
        const first = embedBlocks[0];
        payload.embed = {
          title: first.querySelector('[name="embedTitle"]').value,
          description: first.querySelector('[name="embedDesc"]').value,
          color: first.querySelector('[name="embedColor"]').value
        };
        if (form.content.value) payload.content = form.content.value;
      }

      // ComponentsV2
      const compBlocks = extraBlocks.querySelectorAll('.component-block:not(.nested)');
      if (compBlocks.length > 0) {
        payload.messageType = "componentsv2";
        payload.components = buildComponents(compBlocks);
      }

      console.log("Sending payload:", payload);

      const res = await fetch("http://localhost:65522/api/sendmsg", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      alert(JSON.stringify(data, null, 2));
    });
    updatePreview();
  </script>
  <script>
      (function () {
          const { hostname, port } = window.location;
          if (hostname === 'localhost' || port === '25525') {
              // Update favicon
              const favicon = document.querySelector('link[rel="icon"]');
              if (favicon) {
                  favicon.href = 'https://thatwest7014.pages.dev/imgs/Novaworks/Novaworks.png';
              }
          
              // Update navbar logo
              const navbarLogo = document.querySelector('.navbar-logo');
              if (navbarLogo) {
                  navbarLogo.src = 'https://thatwest7014.pages.dev/imgs/Novaworks/Novaworks-Banner.png';
              }
          }
      })();
  </script>
</body>
</html>
